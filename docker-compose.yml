
# This is augmented with dependent services by
# sh/augmented_docker_compose.sh

version: '3.7'

services:

  nginx:
    build:
      context: source/nginx_stub
    container_name: test-nginx
    image: cyberdojo/nginx_creator_stub
    ports: [ "${CYBER_DOJO_NGINX_PORT}:${CYBER_DOJO_NGINX_PORT}" ]
    user: root

  # - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

  client:
    image: ${CYBER_DOJO_CREATOR_CLIENT_IMAGE}:${CYBER_DOJO_CREATOR_TAG}
    build:
      args: [ COMMIT_SHA, CYBER_DOJO_CREATOR_CLIENT_PORT ]
      context: source/client
    container_name: ${CYBER_DOJO_CREATOR_CLIENT_CONTAINER_NAME}
    depends_on:
      - nginx
      - custom-start-points    # for test data
      - exercises-start-points # for test data
      - languages-start-points # for test data
      - selenium               # for testing
      - creator
    env_file:
      - .env
    ports: [ "${CYBER_DOJO_CREATOR_CLIENT_PORT}:${CYBER_DOJO_CREATOR_CLIENT_PORT}" ]
    read_only: true
    restart: "no"
    tmpfs: /tmp
    user: nobody
    volumes: [ "./test:/test/:ro" ]

  # - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

  creator:
    image: ${CYBER_DOJO_CREATOR_IMAGE}:${CYBER_DOJO_CREATOR_TAG}
    build:
      args: [ COMMIT_SHA, CYBER_DOJO_CREATOR_PORT ]
      context: source/server
    container_name: ${CYBER_DOJO_CREATOR_SERVER_CONTAINER_NAME}
    depends_on:
      - custom-start-points
      - exercises-start-points
      - languages-start-points
      - runner
      - model
    env_file:
      - .env
    ports: [ "${CYBER_DOJO_CREATOR_PORT}:${CYBER_DOJO_CREATOR_PORT}" ]
    read_only: true
    restart: "no"
    tmpfs: /tmp
    user: nobody
    volumes: [ "./test:/test/:ro" ]
